name: Continuous Integration

on: [push, pull_request]

env:
    LLVM_VERSION: 10.0.0
    CMAKE_VERSION: 3.16.6
    NINJA_VERSION: 1.10.0
    GLFW_VERSION: 3.3.2

jobs:
    build:
        name: ${{ matrix.cfg.name }} ${{ matrix.build_type }}
        runs-on: ${{ matrix.cfg.os }}

        strategy:
            fail-fast: false
            matrix:
                build_type: [Debug, Release]#, RelWithDebInfo, MinSizeRel]
                cfg:
                    # - { name: "[Windows] MSVC",  os: windows-latest, cc: cl,    cxx: cl }
                    - { name: "[Windows] MinGW", os: windows-latest, cc: gcc,   cxx: g++ }
                    # - { name: "[Windows] Clang", os: windows-latest, cc: clang, cxx: clang++ }
                    - { name: "[Linux] GNU",     os: ubuntu-latest,  cc: gcc-9, cxx: g++-9 }
                    - { name: "[Linux] Clang",   os: ubuntu-latest,  cc: clang, cxx: clang++ }
                    - { name: "[macOS] GNU",     os: macos-latest,   cc: gcc,   cxx: g++ }
                    - { name: "[macOS] Clang",   os: macos-latest,   cc: clang, cxx: clang++ }

        steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v1
          with:
            python-version: '3.x'
            architecture: 'x64'
        - name: Download dependencies
          shell: cmake -P {0}
          run: |
            set(llvm_version $ENV{LLVM_VERSION})
            set(cmake_version $ENV{CMAKE_VERSION})
            set(ninja_version $ENV{NINJA_VERSION})
            set(glfw_version $ENV{GLFW_VERSION})

            message(NOTICE "Using host CMAKE version: ${CMAKE_VERSION}")

            if("${{ runner.os }}" STREQUAL "Windows")
                set(llvm_url "https://ziglang.org/deps/llvm%2bclang%2blld-${llvm_version}-x86_64-windows-msvc-release-mt.tar.xz")
                set(cmake_url "https://github.com/Kitware/CMake/releases/download/v${cmake_version}/cmake-${cmake_version}-win64-x64.zip")
                set(ninja_url "https://github.com/ninja-build/ninja/releases/download/v${ninja_version}/ninja-win.zip")
                set(glfw_url "https://github.com/glfw/glfw/releases/download/${glfw_version}/glfw-${glfw_version}.bin.WIN64.zip")

                set(llvm_dir "llvm+clang+lld-${llvm_version}-x86_64-windows-msvc-release-mt/bin")
                set(cmake_dir "cmake-${cmake_version}-win64-x64/bin")
            elseif("${{ runner.os }}" STREQUAL "Linux")
                set(llvm_url "https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm_version}/clang+llvm-${llvm_version}-x86_64-linux-gnu-ubuntu-18.04.tar.xz")
                set(cmake_url "https://github.com/Kitware/CMake/releases/download/v${cmake_version}/cmake-${cmake_version}-Linux-x86_64.tar.gz")
                set(ninja_url "https://github.com/ninja-build/ninja/releases/download/v${ninja_version}/ninja-linux.zip")
                set(glfw_url "https://github.com/glfw/glfw/releases/download/${glfw_version}/glfw-${glfw_version}.zip")

                set(llvm_dir "clang+llvm-${llvm_version}-x86_64-linux-gnu-ubuntu-18.04/bin")
                set(cmake_dir "cmake-${cmake_version}-Linux-x86_64/bin")
            elseif("${{ runner.os }}" STREQUAL "macOS")
                set(llvm_url "https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm_version}/clang+llvm-${llvm_version}-x86_64-apple-darwin.tar.xz")
                set(cmake_url "https://github.com/Kitware/CMake/releases/download/v${cmake_version}/cmake-${cmake_version}-Darwin-x86_64.tar.gz")
                set(ninja_url "https://github.com/ninja-build/ninja/releases/download/v${ninja_version}/ninja-mac.zip")
                set(glfw_url "https://github.com/glfw/glfw/releases/download/${glfw_version}/glfw-${glfw_version}.bin.MACOS.zip")

                set(llvm_dir "clang+llvm-${llvm_version}-x86_64-apple-darwin/bin")
                set(cmake_dir "cmake-${cmake_version}-Darwin-x86_64/CMake.app/Contents/bin")
            endif()

            message(NOTICE "::add-path::${CMAKE_SOURCE_DIR}")

            file(DOWNLOAD "${llvm_url}" ./llvm.zip SHOW_PROGRESS)
            execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./llvm.zip)
            message(NOTICE "::add-path::${CMAKE_SOURCE_DIR}/${llvm_dir}")

            file(DOWNLOAD "${cmake_url}" ./cmake.zip SHOW_PROGRESS)
            execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./cmake.zip)
            message(NOTICE "::add-path::${CMAKE_SOURCE_DIR}/${cmake_dir}")

            file(DOWNLOAD "${ninja_url}" ./ninja.zip SHOW_PROGRESS)
            execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ninja.zip)

            file(DOWNLOAD "${glfw_url}" ./glfw.zip SHOW_PROGRESS)
            execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./glfw.zip)
        - name: Set up system
          shell: bash
          run: |
            if [ "${{ runner.os }}" == "Windows" ]; then
                :
            elif [ "${{ runner.os }}" == "Linux" ]; then
                sudo apt update -y
                sudo apt install -y libglfw3-dev libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev
            elif [ "${{ runner.os }}" == "macOS" ]; then
                :
            fi

            python -m pip install --upgrade pip
            pip install pipenv pyyaml beautysh cmake-format
            pipenv install
            # pip install -r requirements.txt
        # - name: Software versions
        #   shell: bash
        #   run: |
        #     echo "clang-format"
        #     clang-format --version

        #     echo "clang-tidy"
        #     clang-tidy --version

        #     echo "clang-apply-replacements"
        #     clang-apply-replacements --version

        #     echo "cmake"
        #     cmake --version

        #     echo "ctest"
        #     ctest --version

        #     echo "ninja"
        #     ninja --version

        #     echo "beautysh"
        #     beautysh --version

        #     echo "cmake-format"
        #     cmake-format --version
        - name: Configure build
          shell: bash
          run: |
            cmake -G"Ninja" -S. -Bbuild -DCMAKE_C_COMPILER=${{ matrix.cfg.cc }} -DCMAKE_CXX_COMPILER=${{ matrix.cfg.cxx }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_EXPORT_COMPILE_COMMANDS=YES
            ln -sf build/compile_commands.json .
        # - name: Check shell formatting
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./beautysh.bash check
        # - name: Check build formatting
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./cmake-format.bash check
        # - name: Check include guards
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./include-guards.bash check
        # - name: Check test cases
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./test-cases.bash check
        # - name: Check code formatting
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./clang-format.bash check
        # - name: Check static analysis
        #   shell: bash
        #   working-directory: ./utils
        #   run: |
        #     ./clang-tidy.bash check
        - name: Run build
          shell: bash
          working-directory: ./build
          run: |
            cmake --build .
        - name: Run tests
          shell: bash
          working-directory: ./build
          run: |
            ctest -VV --timeout 30 -E "pkg-config"
